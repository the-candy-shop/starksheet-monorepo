import logging
import os
import re
from enum import Enum
from pathlib import Path

from dotenv import load_dotenv
from starknet_py.net.gateway_client import GatewayClient

logging.basicConfig()
logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)
load_dotenv()

ETH_TOKEN_ADDRESS = 0x49D36570D4E46F48E99674BD3FCC84644DDD6B96F7C741B1562B82F9E004DC7
EVM_ADDRESS = os.getenv("EVM_ADDRESS")
NETWORK = os.getenv("STARKNET_NETWORK", "starknet-devnet")
NETWORK = (
    "testnet"
    if re.match(r".*(testnet|goerli)$", NETWORK, flags=re.I)
    else "testnet2"
    if re.match(r".*(testnet|goerli)-?2$", NETWORK, flags=re.I)
    else "mainnet"
    if re.match(r".*mainnet$", NETWORK, flags=re.I)
    else "docker"
    if re.match(r".*docker$", NETWORK, flags=re.I)
    else "devnet"
)
GATEWAY_URLS = {
    "mainnet": "https://alpha-mainnet.starknet.io",
    "testnet": "https://alpha4.starknet.io",
    "testnet2": "https://alpha4-2.starknet.io",
    "devnet": "http://127.0.0.1:5050",
    "docker": "http://starknet-devnet:5050",
}
GATEWAY_CLIENT = GatewayClient(net=GATEWAY_URLS[NETWORK])
STARKNET_NETWORKS = {
    "mainnet": "alpha-mainnet",
    "testnet": "alpha-goerli",
    "testnet2": "alpha-goerli2",
    "devnet": "alpha-goerli",
    "docker": "alpha-goerli",
}
STARKNET_NETWORK = STARKNET_NETWORKS[NETWORK]
STARKSCAN_URLS = {
    "mainnet": "https://starkscan.co",
    "testnet": "https://testnet.starkscan.co",
    "testnet2": "https://testnet-2.starkscan.co",
    "devnet": "https://devnet.starkscan.co",
    "docker": "https://devnet.starkscan.co",
}
STARKSCAN_URL = STARKSCAN_URLS[NETWORK]


class ChainId(Enum):
    mainnet = int.from_bytes(b"SN_MAIN", "big")
    testnet = int.from_bytes(b"SN_GOERLI", "big")
    testnet2 = int.from_bytes(b"SN_GOERLI2", "big")
    devnet = int.from_bytes(b"SN_GOERLI", "big")
    docker = int.from_bytes(b"SN_GOERLI", "big")


CHAIN_ID = getattr(ChainId, NETWORK)

DEPLOYMENTS_DIR = Path("deployments") / NETWORK
DEPLOYMENTS_DIR.mkdir(exist_ok=True)
BUILD_DIR = Path("build")
SOURCE_DIR = Path("src")
CONTRACTS = {p.stem: p for p in list(SOURCE_DIR.glob("**/*.cairo"))}

ACCOUNT_ADDRESS = (
    os.environ.get(f"{NETWORK.upper()}_ACCOUNT_ADDRESS")
    or os.environ["ACCOUNT_ADDRESS"]
)
PRIVATE_KEY = (
    os.environ.get(f"{NETWORK.upper()}_PRIVATE_KEY") or os.environ["PRIVATE_KEY"]
)
ONSHEET_OWNER_ADDRESS = os.environ["ACCOUNT_ADDRESS"]
ONSHEET_PRIVATE_KEY = os.environ["PRIVATE_KEY"]

N_COLS = 15
N_ROWS = 15

ALLOW_LIST = [
    int(ACCOUNT_ADDRESS, 16),
    0x00140440374CA75F0732670014042D2645F637356A34D16C2F44955EA7941D3D,
    0x007506DE8FAFC710ECFF05A5A59E5F0BBA86FB194CA96648314FC3BCE9FFCD56,
    0x007EDC3D948BF1BE9BDEC7582B0BFFE85D6A5D101AB408807E5B75F27F257882,
    0x00DEB3050FFB0FA2C7367D3CAB1C8D4E28104A51E131076028B702D279BDAEA2,
    0x00FE0AFDB7BD9C314822F714AEE41598882DABDEF3BF9226D56FC0F92A7B2FD1,
    0x01002BFE4D330AEEE10D35205BDF4DB5F25A779271F07C4BAF51C9EFC87769CD,
    0x010031C9FB2668771B114805BF6F210E631D4F67C038912281D9E1EF5484F5CF,
    0x0115FF62323D7A7C7035963EAB3C8396944334B26495244B67E9F8413B97A1CF,
    0x012DEB3C48C50CDC5443F21AD518CB16D4FE80FDDF029A090609239A0FD902D7,
    0x0161A9BCA8DCC5975A03B12F5F7BF9610E1541635EB40EB3A89BAEEDC168E636,
    0x0172BA0ACF340A7EA757E40217E843759EEE6D53A6C7F67E6E967BB4D49BE469,
    0x01EA76D8967B444C2EB9B89C4123568CA4087C316B104C3339D7613116292374,
    0x02041223A611AE7D30C26FE9707D36FB7494219E87C6D0DB9C7DCFA36A4A255A,
    0x020918C70E1DFB7E3CD6811A37F9B027C4883DDA8123CCCD1E3E3B252C2CC2D2,
    0x0228C6594B25E7C93FB4F82F6D049E495B588279CE3D4F50B71D724A2BB75EE7,
    0x027D6AEFF1ABA4377165A2B210C072E96DCE1DD0AB71668A580CA4A9EE5433FF,
    0x028F7CA787A9502C4475889649A2DE03094E263CBDE2D53BFCEF816B6617210C,
    0x02A1EC511DBCED8D34997FBADFCB72E173910CA00901EE123EEF6A0548EC5E66,
    0x02D4E16CCBBB0F1A2DCB105EA1650BA21F39424F5E8CC7DF178D332A59EECEF9,
    0x030BC99341266F72B9BB2AF77A949E5E995CDC9AEE00479BD19C56234FA00A6C,
    0x03299DBE2C836A92689F78D97D94156BB183A406C2B7DFC084E0D7E55126D564,
    0x0360C4F27BD9AF2A05B416FF573738E8587883862A90965A1716DFA9D17F3E79,
    0x0367C0C4603A29BC5ACA8E07C6A2776D7C0D325945ABB4F772F448B345CA4CF7,
    0x03766DCCE98C89ACF3A9F14F8F5406AAE6F04E0C570A759DC4DF7D59A6B3ED34,
    0x0378529943ACD450C6B0C549821C799725E83EB08579AAFC885D923527C3C10E,
    0x038775A408D0D3EB9F6B78FD3FB23932CAD69A466AFD2A06D982D7C8A1F23CB9,
    0x038D9BAE3A0DABA89843DDDA6A58300FBC89CA8E850B623090E230E4D9277106,
    0x03BC4F3912468951B3BE911B9476177CC208DAE52AE4F880540F4D24D3C61847,
    0x03CB1C6873766CE2BE9FBF4EBD1EFFE0307BE72F8DEB02E9F222DF7264BE286C,
    0x03EC19AB941EAB03DB17BEE98AB73CAFB96F3BC3753980291D5BE3106911C1AD,
    0x03FB57EA6C31C3E8C7815C4B7F038AC031763262C705C55734FDDC9F76E324E8,
    0x0404756B85A9398366B144484B58DA2A7798B4BA74BDAF42DB376358093586E0,
    0x0445F2E3F457C9B485C747AC45AED7BEF2EFA3BDBCA2376FCFABBE87C05B4257,
    0x04E8FA25C1C786BB014311ED21CD5C5E0AA0B44A276FA6C6775F26FEBAAED2FB,
    0x04F60CA5E2367D9CB2F047713DBEB288475FCB7E14E717A47D7D3848C98DC4CE,
    0x05547E736CC915EF3F475508A624D9C3C33DA5856B23FE9D99F487DACEA67A13,
    0x0577EF67D52B8DA80116B514876C8B8C418F3527019A2CA5C07BF25D26714F21,
    0x05799EC529081348E0A1C17B5C6DFA25DABA0C634CBAA419DB9F5B4298B48529,
    0x0586E8D37740E23376CFEEAAADD55A3423AC403FDAD668E4B9AD23C5575320DC,
    0x058863ACF3C46876F5A7D131986B94A1EDA58CD18EDCBCF503534A661BF67A1E,
    0x05CB068B58E52F20D19EC4DA91836376F264DE52F0AF067B58B86DE83B6EF6CD,
    0x05CC789A382FFE2DBCCA344EA42491E2784E0938E7506BB36970A915A7FE5E33,
    0x05DF1B6D56F925DC58050DB38801D84DA2B5EC45B48E5ED64E260B655E36F52B,
    0x05EB40EB990983CC674AE0F66FB35305FF08613ADA349D0759E25B3F96977E60,
    0x063865B2103948DF4ABA69A01C502B32FBCE6DFA14EA323B9136014BBBFFA139,
    0x06461CDE14F31B96863926E5748FF67C8331741C3E813C9360E985930F697300,
    0x0661FDC6B170DE87C583675B2F2B6E74DC1F78208CB745B1C4DDA3586662DCB8,
    0x066243C879305289B401B5A297351557FEF92AE82680645A0EECCC065A188C9C,
    0x067A3A7C4D19B388756CA5EC567DD5E56FA1BB40D95D0168A0F87302A2B77E6D,
    0x06CDEEE45C897A485224419140B98A6027EC28B21FECB60CAD7E7E105196D31D,
    0x07360AEE5743EBA462E17E1886CCA91BE06AD5110FD3142D284332AF3FC7248B,
    0x07934B6F4E48E4A4CE6A65077E711EC7D2034BC8062C2F7FC33CB20C0970FA7C,
    0x0795EA272324B62BF2E46C3993E38FB808E434606B5F7E7AE93FE989B174730D,
    0x07D0E599D01A378A1906CBC6E8B6A69C7A310E543FB31503CE06C73B67302123,
    0x2F6189B63A8C1688A8FC8ABC1A9EA46D27964C4666B92DB19886334FD24E66F,
    0x2F809EDB8B1FFD707F2BA8C08DCC99F29033244EE065ACE83DE0465B1672A05,
    0x36C9B1D9B513CAA91C991642B4C0BAF58626848CDA27FF53E79EE62AF3B9BA1,
    0x38D91FEB1FF00F40601A253427A35BE03843FF6BEC15465ED1B63A5B86689DD,
    0x531DAEDE43EA79FE99B2368685CA8F8CBD03CF6151F1FA562E08C48D968511B,
    0x63F2837E8809E583820994CEA735E4F95612BD59A929BF1EC73E35CCEC93241,
    0x6B66F70B8E4501EDDD8E8C2AE046B207FC66B80D33397768D1048AAF9848F74,
    0x7559C0721EA6A36A5B0317A08DA540F0C64263D6FA0E0B8AA6AA8F584C19BB8,
    0x951BBCA64556E639B54C88278E6F734948969B2BDF27A2BD9008AFE6D6B7C0,
]


STARKNET_ID_ADDRESS = {
    "mainnet": 0x05DBDEDC203E92749E2E746E2D40A768D966BD243DF04A6B712E222BC040A9AF,
    "testnet": 0x0783A9097B26EAE0586373B2CE0ED3529DDC44069D1E0FBC4F66D42B69D6850D,
    "devnet": 0x0783A9097B26EAE0586373B2CE0ED3529DDC44069D1E0FBC4F66D42B69D6850D,
    "docker": 0x0783A9097B26EAE0586373B2CE0ED3529DDC44069D1E0FBC4F66D42B69D6850D,
}[NETWORK]
STARKNET_ID_NAMING = {
    "mainnet": 0x06AC597F8116F886FA1C97A23FA4E08299975ECAF6B598873CA6792B9BBFB678,
    "testnet": 0x003BAB268E932D2CECD1946F100AE67CE3DFF9FD234119EA2F6DA57D16D29FCE,
    "devnet": 0x003BAB268E932D2CECD1946F100AE67CE3DFF9FD234119EA2F6DA57D16D29FCE,
    "docker": 0x003BAB268E932D2CECD1946F100AE67CE3DFF9FD234119EA2F6DA57D16D29FCE,
}[NETWORK]

logger.info(f"ℹ️  Using Chain id {CHAIN_ID.name} with Gateway {GATEWAY_URLS[NETWORK]}")
